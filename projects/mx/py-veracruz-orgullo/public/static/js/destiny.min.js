(function(){
    var subnav = $('.navbar-destiny'),
        subnav_list = $('#navbar-subnav-list'),
        subnav_tmpl = '<li class="{active}"><a href="#" class="js-ga-track" data-url="{url}" data-category="destiny-subnavbar" data-action="click" data-label="{label}">{name}</a></li>',
        steps = $('.destiny-steps'),
        step_prev = $('#step-prev'),
        step_next = $('#step-next'),
        url_pathname = location.pathname;
    subnav.hide(); steps.hide();
    $.getJSON('/data/destinos.json', {format:'json'}, function(r){
        var item, item_data, item_active, data = r.destiny;
        try{
            if(!data.length){return;}
            for(var a=0; a<data.length; a++){
                item_data = data[a];
                item_active = (item_data.url||'').search(url_pathname);
                item = subnav_tmpl
                     .replace('{url}', item_data.url||'')
                     .replace('{label}', item_data.label||'')
                     .replace('{name}', item_data.name||'')
                     .replace('{active}', (item_active < 0)?'':'active');
                if(item_active > -1){
                    var prev = (!data[a-1])?data[data.length-1]:data[a-1],
                        next = (!data[a+1])?data[0]:data[a+1];
                    step_prev.attr('data-url', prev.url)
                             .attr('data-label', prev.label);
                    step_next.attr('data-url', next.url)
                             .attr('data-label', next.label);
                } subnav_list.append(item);
            } subnav.show(); steps.show();
        }catch(e){}
    }).complete(function() {
        $('.js-ga-track').bind('click', function(e){
            try{
                var ref = $(this);
                var url = ref.attr('data-url')||null;
                var dat = ['_trackEvent',
                    ref.attr('data-category')||"category-undefined",
                    ref.attr('data-action')||"action-undefined",
                    ref.attr('data-label')||"label-undefined"];
                _gaq.push(dat);
                if(url){
                    if((ref.attr('target')||'').toLowerCase()=='_blank'){
                        window.open(url,'_blank');}
                    else{setTimeout('document.location="'+url+'"',100);}
                }
            }catch(e){}
            return;
        });
    });
    $(window).resize(function(){
        var canvas = $('.destiny-box-body');
        if($(window).width()<=979){
            canvas.css('height', '');
        }else{
            var box = $('.destiny-box').height()-20,
                box_head = $('.destiny-box-head').height();
            canvas.css('height', box-box_head);
        }
    }).resize();
    $(window).scrollspy({
        element: $('.destiny-box-body-wrapp'),
        container: $('.destiny-box-body'),
        background: $('.destiny-background'),
        shadow: $('.destiny-box-body-sw')
    });
})();